# backtesting-engine Specification

## Purpose
TBD - created by archiving change add-auto-trading-mechanism. Update Purpose after archive.
## Requirements
### Requirement: 系统必须提供一个回测引擎，用于在历史数据上评估交易策略。
**说明**: 回测引擎是科学验证策略有效性的核心工具，能够帮助用户在投入真实资金前了解策略的潜在表现和风险。

**#### Scenario: 用户希望回测一个简单的均线交叉策略。**
- `GIVEN` 用户已定义一个“当 MA5 上穿 MA20 时买入，下穿时卖出”的策略。
- `AND` 用户指定回测时间段为 `2023-01-01` 至 `2023-12-31`。
- `WHEN` 用户启动回测命令。
- `THEN` 系统必须按天遍历该时间段的历史数据，并在每个交易日模拟执行策略的买卖决策。
- `AND` 回测结束后，系统必须输出一份包含总回报率、最大回撤和夏普比率的绩效报告。

### Requirement: 回测过程必须严格避免“未来函数”。
**说明**: 在历史数据回测的任何一个时间点 `T`，策略的决策过程都只能使用 `T` 时刻及之前可获得的信息，严禁使用 `T` 时刻之后的数据，以保证模拟的公平性。

**#### Scenario: 回测进行到 2023-06-15 这一天。**
- `GIVEN` 回测引擎的主循环正在处理 `2023-06-15` 的数据。
- `WHEN` 引擎调用分析模块（`DecisionAgent`）进行决策。
- `THEN` 传递给分析模块的所有数据（如K线、成交量、均线值等）都必须是基于 `2023-06-15` 及之前的数据计算得出的。
- `AND` 策略在这一天做出的任何决策，都不能利用 `2023-06-16` 或之后的价格、新闻或任何信息。

### Requirement: 回测引擎必须能够生成一份标准化的绩效报告。
**说明**: 为了方便用户评估和比较不同策略的表现，回测结果需要以标准化的指标呈现。

**#### Scenario: 一次回测成功运行完毕。**
- `GIVEN` 回测引擎已完成对指定时间段的模拟。
- `WHEN` 引擎调用报告生成模块。
- `THEN` 系统必须计算并展示至少以下几个核心指标：
  - `总回报率 (Total Return)`
  - `年化回报率 (Annualized Return)`
  - `最大回撤 (Maximum Drawdown)`
  - `夏普比率 (Sharpe Ratio)`
  - `总交易次数 (Total Trades)`
  - `胜率 (Win Rate)`

