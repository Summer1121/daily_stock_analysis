# 设计方案: 实盘交易模块集成

## 1. 概述

本设计旨在为系统引入实盘交易能力，支持两种主要方式：通过券商官方量化API进行交易，以及通过模拟人工操作（如自动化浏览器）进行交易。两者都将作为 `trading.brokers.base.AbstractBroker` 的具体实现，确保核心交易逻辑的统一性。

## 2. 架构设计

![Real Trading Module Architecture](diagrams/real_trading_architecture.png)
*(Note: The above is a placeholder for a future architecture diagram.)*

### 2.1 扩展 `AbstractBroker` 接口

`trading.brokers.base.AbstractBroker` 将是所有实盘经纪商的基类。未来可能需要根据真实交易的复杂性，在 `AbstractBroker` 中增加或调整方法，例如：
*   更详细的订单状态回调/查询机制。
*   交易费用、税费的获取。
*   更多种类的订单类型支持（如限价止损、市价止损等）。
*   连接状态管理。

### 2.2 量化接口经纪商 (RealBroker via API)

*   **实现**: 创建 `trading.brokers.real_api_broker.py` (或其他具体券商命名的文件，如 `guosen_api_broker.py`)，实现 `AbstractBroker` 接口。
*   **依赖**: 依赖特定券商提供的Python SDK或API接口（例如 `rqalpha` 框架的接入方式，或直接调用券商的REST/WebSocket API）。
*   **认证**: 处理券商API的身份验证（API Key, Secret, Token, 证书等）。
*   **数据**: 通过API获取实时行情数据和交易数据。
*   **配置**: 在 `config.py` 中增加券商API相关的配置项。
*   **优势**: 稳定、高效、官方支持，合法合规性好。
*   **挑战**: 各券商API接口不统一，接入成本高，部分券商对个人用户或资金量有门槛。

### 2.3 模拟人工操作经纪商 (RealBroker via UI Automation)

这是本次需求中需要着重调研的部分，但**强烈不推荐直接用于实盘交易**，尤其是针对中国大陆的券商。原因详述如下：

*   **实现**: 创建 `trading.brokers.ui_automation_broker.py`，实现 `AbstractBroker` 接口。
*   **核心思路**: 通过程序自动化控制浏览器或调用第三方交易客户端的接口，模拟用户在交易软件或网页上的操作。

*   **技术选型 (调研方向与风险评估)**:
    1.  **浏览器自动化工具**:
        *   **Playwright**: 微软开发的下一代浏览器自动化工具，支持 Chromium, Firefox, WebKit，API 更现代，支持异步操作，反检测能力优于 Selenium。**如果必须使用UI自动化，Playwright 是首选。**
        *   **Selenium**: 广泛使用的浏览器自动化测试工具，支持多种浏览器，生态成熟。
        *   **优势**: 理论上能够模拟真实用户行为，操作任何基于Web的交易界面。
        *   **挑战 (以及为什么强烈不推荐用于实盘)**:
            *   **法律与合规风险 (极高)**:
                *   **违反服务条款**: 绝大多数券商的服务条款都明确禁止未经授权的自动化访问和数据抓取。违反这些条款可能导致账户被封禁，甚至面临法律诉讼。
                *   **中国监管政策**: 中国证监会于2024年10月8日正式生效的《证券市场程序化交易管理规定（试行）》明确要求程序化交易活动必须向证券交易所报告，并通过券商的审核和管理。未经授权的第三方程序直接接入市场进行交易是**不被允许的**。任何“模拟人操作”绕过官方渠道的行为都将面临严重的法律和合规风险。
            *   **稳定性与维护成本 (高)**:
                *   **网页结构变化**: 交易平台的网页界面经常更新，任何微小的HTML结构变化都可能导致您的爬虫脚本失效，需要持续维护。
                *   **反爬机制**: 券商网站通常部署复杂的反爬机制，包括但不限于验证码（CAPTCHAs）、IP限制和封禁、用户行为分析、JS加密等，难以自动化处理。
                *   **登录与会话管理**: 维护登录状态、处理会话过期、二次验证等问题复杂且不稳定。
                *   **弹窗/通知**: 需要处理各种交易确认弹窗、系统通知等，这些也容易变化。
            *   **性能与延迟 (差)**: 浏览器自动化比直接API调用慢得多，对于对时间敏感的交易（尤其是中国A股T+0的某些情况或抢板等），延迟可能导致交易失败或错过最佳时机。
            *   **资源消耗**: 浏览器运行需要较多系统资源。

    2.  **第三方交易工具SDK/API**:
        *   **同花顺、大智慧、东方财富等桌面客户端**: 这些客户端通常不提供官方的Python SDK来直接控制交易。可能存在第三方社区开发的非官方接口，但通常不稳定、风险高。通过UI自动化工具（如 `PyAutoGUI` for Windows）进行桌面应用层的操作，也存在上述浏览器自动化的稳定性、合规性风险，且更依赖操作系统环境。
        *   **老虎证券、富途证券等国际化平台**: 部分平台可能提供官方的Python交易API，应优先使用。对于其Web/客户端，如果自动化，则面临与浏览器自动化相同的风险。
        *   **总结**: 对于第三方工具，**应优先调研其官方提供的API或SDK**。

*   **操作流程 (示例，以浏览器自动化为例，仅供技术探讨，不建议实盘)**:
    1.  **登录**: 导航到券商交易页面，输入账号密码，处理验证码（如果需要，可能需要人工输入或接入第三方打码平台，增加风险）。
    2.  **查询**: 模拟点击查询按钮，获取账户余额、持仓等信息。
    3.  **下单**: 模拟输入股票代码、买卖方向、数量、价格，点击下单按钮，处理确认弹窗。
    4.  **撤单**: 模拟查询订单列表，点击撤单按钮，处理确认弹窗。
    5.  **错误处理**: 捕获页面上的错误信息（如资金不足、股票代码错误），转换为系统内部错误。
    6.  **会话保持**: 定期检查登录状态，必要时重新登录。

*   **安全性 (极度关注)**:
    *   敏感凭证（账号、密码）**绝不能硬编码**。应通过加密配置、环境变量或安全的密钥管理服务管理。
    *   自动化操作应在严格受控、隔离的环境中进行。
    *   **强烈建议仅在资金量极小的模拟账户或经过严格测试且充分了解并接受所有风险的情况下进行技术验证。**

**强烈风险提示**:
**通过模拟人工操作进行实盘交易，存在巨大的法律、合规、资金安全和稳定性风险。这可能违反券商的服务协议、中国证监会的监管规定，并导致账户被封禁、资金损失甚至法律责任。在任何情况下，若非必要且充分理解并接受所有风险，不应在实盘中使用此功能。系统在实现此功能时，必须向用户提供明确、醒目的风险提示和免责声明。**

## 3. 配置管理

在 `config.py` 中增加实盘交易相关的配置项，例如：
*   `TRADING_MODE`: 'paper', 'real_api', 'real_ui_automation'
*   `REAL_BROKER_TYPE`: 'guosen', 'htsc', 'ths' (用于区分不同的API或UI自动化实现)
*   `BROKER_API_KEY`, `BROKER_API_SECRET`
*   `BROKER_ACCOUNT`, `BROKER_PASSWORD` (加密存储)
*   `UI_AUTOMATION_HEADLESS`: True/False (是否无头模式运行浏览器)
*   `UI_AUTOMATION_BROWSER`: 'chrome', 'firefox'

## 4. 风险与规避

*   **法律风险**: 对于模拟人工操作，需用户自行评估其券商的服务条款，并自行承担相关风险。系统应提供明确的风险提示。
*   **稳定性风险**: 引入监控机制，当自动化操作失败时及时报警并回退到人工介入。
*   **安全风险**: 严格遵守敏感信息不落地原则，使用加密存储或运行时传入。

## 5. 用户界面集成 (初步设想)

*   在配置页面增加实盘交易模式选择（量化API/模拟人工操作）。
*   根据选择的模式，动态显示相应的配置表单（API密钥输入、账号密码输入、浏览器选择等）。
*   提供连接测试功能，验证实盘账户是否能正常连接。
