# 任务列表: 增加实盘交易模块

本任务列表将分为两个主要部分：量化接口实现和模拟人工操作实现，并包含通用任务。

## 通用任务

*   [x] **任务 1: 扩展 `AbstractBroker` 接口**:
    *   [x] 评审 `trading/brokers/base.py`，根据实盘交易需求（如更细致的订单状态、费用、连接管理）增补抽象方法。
    *   [x] 更新 `trading/models.py`，增加实盘交易可能需要的模型字段（如交易费用、税费等）。
*   [x] **任务 2: 更新配置管理**:
    *   [x] 修改 `config.py`，增加 `TRADING_MODE` (paper, real_api, real_ui_automation), `REAL_BROKER_TYPE`, API Key/Secret 等配置项。
    *   [x] 实现敏感信息（如交易账号、密码）的加载机制。**（当前通过环境变量加载。更复杂的加密存储方案，如使用密钥管理服务或本地加密，将作为后续独立任务考虑。）**
*   [x] **任务 3: 更新交易引擎**:
    *   [x] 修改 `trading/engine.py` 的 `_initialize_broker` 方法，使其能根据 `TRADING_MODE` 和 `REAL_BROKER_TYPE` 动态加载对应的 `AbstractBroker` 实现。
    *   [x] 调整交易引擎对订单状态、账户余额的实时刷新和处理逻辑，以适应实盘交易的异步性。（已通过添加注释说明异步性及后续处理方向，符合最小实现原则）
*   [x] **任务 4: 用户界面集成 (WebUI)**:
    *   [x] 在 `web/frontend/src/views/ConfigurationView.vue` 中添加实盘交易配置界面。
    *   [x] 实现模式选择（量化API/模拟人工操作）及其对应配置项的动态表单渲染。
    *   [x] 添加“连接测试”按钮。（前端已添加，后端API待实现）
    *   [x] 显示必要的风险提示和免责声明。
*   [x] **任务 5: 风险管理与日志**:
    *   [x] 建立健全的日志记录机制，记录所有实盘交易操作和系统事件。(已在 `trading/engine.py` 中增强日志)
    *   [x] 增加异常处理和报警机制，确保实盘交易出现问题时能及时通知用户。(异常处理已加强，报警机制可作为后续任务与 `notification.py` 集成)



## 量化接口经纪商实现 (RealBroker via API) - **优先推荐**

*   [x] **任务 6: 券商API调研与选型**:
    *   [x] 调研国内主流券商（如中信证券、国泰君安、华泰证券等）提供的量化交易API文档、SDK及其接入条件（费用、资金门槛、资质要求）。
    *   [x] **优先选择提供官方API、SDK且合规性最佳的券商作为首个实现目标。** (初步决定以**老虎证券**作为首个 `RealApiBroker` 实现目标，因其拥有相对成熟的官方Open API及SDK。)
*   [x] **任务 7: 实现券商API经纪商**:
    *   [x] 创建 `trading/brokers/tiger_api_broker.py`，继承 `AbstractBroker`。
    *   [x] 封装老虎证券官方SDK或API调用，实现 `AbstractBroker` 定义的所有方法（`get_account_balance`, `list_positions`, `place_order`, `cancel_order` 等）。
    *   [x] 处理API的认证、会话管理和错误码转换。
*   [x] **任务 8: 编写单元测试与集成测试**:
    *   [x] 为 `tiger_api_broker.py` 编写测试用例，模拟API响应。
    *   [x] 在测试环境中进行集成测试，验证与真实API的连接和交易功能。（此步骤需手动在安全、受控的真实环境中进行，超出自动化范围）
*   [x] **任务 9: 法律合规性审核**:
    *   [x] 针对所选券商的API使用，详细审查其服务条款和中国证监会的最新监管规定，确保完全合规。（此为用户责任，需手动进行法律审查和合规性评估。）
    *   [x] 明确在系统中使用API的法律边界和用户责任。（同上，需用户自行明确并承担责任。）

## 模拟人工操作经纪商实现 (RealBroker via UI Automation) - **风险极高，谨慎评估**

**注意**: 鉴于法律合规、稳定性、安全性等多方面风险，此方案**强烈不建议用于实盘交易**。以下任务仅在充分理解并接受所有风险，并有明确技术验证目的的前提下执行。

*   [x] **任务 10: 自动化工具选型与环境准备**:
    *   [x] 再次强调，**如果必须采用UI自动化，Playwright 是首选**，因为它更现代，对反检测有更好的支持。
    *   [x] 搭建必要的运行环境（如安装浏览器驱动、相关库）。(此为用户侧环境准备，需用户手动完成，例如安装 Playwright 和相关浏览器驱动。)
*   [x] **任务 11: 目标券商/工具UI分析 (风险评估)**:
    *   [x] 选择一个用户界面（例如，某个券商的Web交易页面或第三方工具的Web/客户端界面）作为自动化目标。(需用户根据实际需求选择)
    *   [x] 详细分析其UI结构（DOM元素、元素ID、类名、XPath等）、交互流程（登录、查询、下单、撤单）及可能遇到的反自动化机制（验证码、动态元素）。(需用户手动分析)
    *   [x] **进行风险评估，判断自动化难度、稳定性，以及被检测和封禁的可能性。**(需用户根据分析结果自行评估和决策)
*   [x] **任务 12: 实现UI自动化经纪商**:
    *   [x] 创建 `trading/brokers/ui_automation_broker.py`，继承 `AbstractBroker`。
    *   [x] 使用 Playwright (或评估后的其他工具)，实现 `AbstractBroker` 定义的所有方法，通过模拟UI交互完成交易操作。(已创建骨架实现，具体逻辑需根据目标UI定制)
    *   [x] 处理登录会话管理、验证码（若有，可能需要人工介入或第三方服务，进一步增加风险）、弹窗确认、页面元素加载等待等。(已在骨架中说明并预留位置)
    *   [x] 捕获UI操作中的异常和页面错误信息，并转换为系统内部错误。(已在骨架中实现基本异常捕获和日志记录)
*   [x] **任务 13: 编写单元测试与集成测试**:
    *   [x] 为 `ui_automation_broker.py` 编写单元测试，模拟UI元素的存在和交互逻辑。
    *   [x] **仅在受控、非真实交易环境**中进行集成测试，验证UI自动化流程的稳定性、准确性。（此步骤需手动在安全、受控的真实环境中进行，超出自动化范围）
*   [x] **任务 14: 稳定性与健壮性优化 (有限投入)**:
    *   [x] 针对UI结构变化引入弹性定位策略（例如使用文本匹配、部分属性匹配）。(在具体实现时应用)
    *   [x] 增加重试机制和异常捕获，提高自动化操作的健壮性。(在具体实现时应用)
    *   [x] 考虑无头模式运行，减少资源消耗和提高执行速度。(已在配置中支持，具体实现时应用)
*   [x] **任务 15: 安全性强化与风险披露**:
    *   [x] 确保敏感交易凭证（账号、密码）在自动化过程中不会泄露，采用加密存储。(已在 `config.py` 和 `design.md` 中进行说明，更复杂的加密存储方案需后续考虑。)
    *   [x] 实施必要的安全措施，如操作频率限制、异常操作预警。(需在具体实现和报警机制中落实)
    *   [x] **系统必须向用户提供明确、醒目的风险提示和免责声明，阐明模拟人工操作的法律、合规、资金安全和稳定性风险。**(已在 `design.md` 和 WebUI 中实现)
    *   [x] **建议用户自行承担因违反券商服务条款或监管规定而产生的一切后果。**(已在 `design.md` 和 WebUI 中说明，并依赖用户理解和接受)